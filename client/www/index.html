<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link href="lib/ionicons/css/ionicons.min.css" rel="stylesheet">

    <link href="css/style.css" rel="stylesheet">

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <script src="lib/jquery/dist/jquery.min.js"></script>
    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>
    <script src="lib/ionic-rating/ionic-rating.js"></script>
    <script src="lib/ionic-rating/ionic-rating.js"></script>


    <!-- cordova script (this will be a 404 during development) -->
    <!--<script src="cordova.js"></script>-->

    <!-- your app's js -->
    <script src="js/app.js"></script>
    <script src="js/reviewCreateCtrl.js"></script>
    <script src="js/liveFactory.js"></script>
    <script src="js/homeCtrl.js"></script>
    <script src="js/mainCtrl.js"></script>
    <script src="js/newArtistCtrl.js"></script>
    <script src="js/searchResultsCtrl.js"></script>
    <script src="js/artistPageCtrl.js"></script>
       <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
       <meta charset="utf-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
       <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
       <link rel="stylesheet" href="//cdn.webrtc-experiment.com/style.css">

       <style>
       audio {
           vertical-align: bottom;
           width: 10em;
       }
       video {
           max-width: 100%;
           vertical-align: top;
       }
       input {
           border: 1px solid #d9d9d9;
           border-radius: 1px;
           font-size: 2em;
           margin: .2em;
           width: 30%;
       }
       p,
       .inner {
           padding: 1em;
       }
       li {
           border-bottom: 1px solid rgb(189, 189, 189);
           border-left: 1px solid rgb(189, 189, 189);
           padding: .5em;
       }
       label {
           display: inline-block;
           width: 8em;
       }
       </style>
       
       <script>
           document.createElement('article');
           document.createElement('footer');
       </script>
       <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
       <script src="https://cdn.webrtc-experiment.com/gif-recorder.js"></script>
       <script src="https://cdn.webrtc-experiment.com/getScreenId.js"></script>
  </head>
  <body ng-app="liveApp" ng-controller="mainCtrl">

    <ion-pane>
       <article>

              <section class="experiment">
                  <h2 class="header">
                      Record Audio
                  </h2>

                  <div class="inner" style="height: 5em;">
                      <audio id="audio" autoplay controls></audio>
                      <button id="record-audio">Record</button>
                      <button id="pause-resume-audio" disabled>Pause</button>
                      <button id="stop-recording-audio" disabled>Stop</button>
                      <h2 id="audio-url-preview"></h2>
                  </div>
              </section>

              <section class="experiment">

                  <h2 class="header">Record Video (in chrome)</h2>

                  <small>/ <a href="https://www.webrtc-experiment.com/RecordRTC/AudioVideo-on-Firefox.html">Record video on Firefox</a>
                  </small>

                  <div class="inner">
                      <div>
                          <button id="record-video">Record</button>
                          <button id="pause-resume-video" disabled>Pause</button>
                          <button id="stop-recording-video" disabled>Stop</button>
                          <hr>
                          <h2 id="video-url-preview"></h2>
                          <br>
                          <input type="checkbox" id="record-screen" style="width:auto;">
                          <label for="record-screen">Record Screen</label>
                          <br>
                          <video id="video" autoplay loop controls muted></video>
                      </div>
                  </div>
                  
              </section>  

              
              <script>
                  (function() {
                      var params = {},
                          r = /([^&=]+)=?([^&]*)/g;

                      function d(s) {
                          return decodeURIComponent(s.replace(/\+/g, ' '));
                      }

                      var match, search = window.location.search;
                      while (match = r.exec(search.substring(1)))
                          params[d(match[1])] = d(match[2]);

                      window.params = params;
                  })();
              </script>
              
              <script>
              function getByID(id) {
                  return document.getElementById(id);
              }

              var recordAudio = getByID('record-audio'),
                  recordVideo = getByID('record-video'),
                  recordGIF = getByID('record-gif'),
                  stopRecordingAudio = getByID('stop-recording-audio'),
                  pauseResumeAudio = getByID('pause-resume-audio'),
                  pauseResumeVideo = getByID('pause-resume-video'),
                  pauseResumeGif = getByID('pause-resume-gif'),
                  stopRecordingVideo = getByID('stop-recording-video'),
                  stopRecordingGIF = getByID('stop-recording-gif');

              var canvasWidth_input = getByID('canvas-width-input'),
                  canvasHeight_input = getByID('canvas-height-input');
                  
              if(params.canvas_width) {
                  canvasWidth_input.value = params.canvas_width;
              }
              
              if(params.canvas_height) {
                  canvasHeight_input.value = params.canvas_height;
              }

              var video = getByID('video');
              var audio = getByID('audio');

              var videoConstraints = {
                  audio: false,
                  video: {
                      mandatory: {},
                      optional: []
                  }
              };

              var audioConstraints = {
                  audio: true,
                  video: false
              };
              </script>
              <script>
              var audioStream;
              var recorder;

              recordAudio.onclick = function() {
                  if (!audioStream)
                      navigator.getUserMedia(audioConstraints, function(stream) {
                          if (window.IsChrome) stream = new window.MediaStream(stream.getAudioTracks());
                          audioStream = stream;

                          // "audio" is a default type
                          recorder = window.RecordRTC(stream, {
                              type: 'audio',
                              bufferSize: typeof params.bufferSize == 'undefined' ? 16384 : params.bufferSize,
                              sampleRate: typeof params.sampleRate == 'undefined' ? 44100 : params.sampleRate,
                              leftChannel: params.leftChannel || false,
                              disableLogs: params.disableLogs || false
                          });
                          recorder.startRecording();
                      }, function() {});
                  else {
                      audio.src = URL.createObjectURL(audioStream);
                      audio.muted = true;
                      audio.play();
                      if (recorder) recorder.startRecording();
                  }

                  window.isAudio = true;

                  this.disabled = true;
                  stopRecordingAudio.disabled = false;
                  pauseResumeAudio.disabled = false;
              };

              var screen_constraints;

              function isCaptureScreen(callback) {
                  if (document.getElementById('record-screen').checked) {
                      document.getElementById('fit-to-screen').onclick();
                      
                      getScreenId(function (error, sourceId, _screen_constraints) {
                          if(error === 'not-installed') {
                              window.open('https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk');                        
                          }
                          
                          if(error === 'permission-denied') {
                              alert('Screen capturing permission is denied.');
                          }
                          
                          if(error === 'installed-disabled') {
                              alert('Please enable chrome screen capturing extension.');
                          }
                          
                          if(_screen_constraints) {
                              screen_constraints = _screen_constraints.video;
                              videoConstraints = _screen_constraints;
                          }
                          else {
                              videoConstraints = screen_constraints;
                          }
                          
                          callback();
                      });
                  }
                  else {
                      callback();
                  }
              }

              recordVideo.onclick = function() {
                  isCaptureScreen(function() {
                      recordVideoOrGIF(true);
                  });
              };

              recordGIF.onclick = function() {
                  isCaptureScreen(function() {
                      recordVideoOrGIF(false);
                  });
              };

              function recordVideoOrGIF(isRecordVideo) {
                  navigator.getUserMedia(videoConstraints, function(stream) {
                      video.onloadedmetadata = function() {
                          video.width = canvasWidth_input.value || 320;
                          video.height = canvasHeight_input.value || 240;

                          var options = {
                              type: isRecordVideo ? 'video' : 'gif',
                              video: video,
                              canvas: {
                                  width: canvasWidth_input.value,
                                  height: canvasHeight_input.value
                              },
                              disableLogs: params.disableLogs || false,
                              recorderType: null // to let RecordRTC choose relevant types itself
                          };

                          recorder = window.RecordRTC(stream, options);
                          recorder.startRecording();
                          
                          video.onloadedmetadata = false;
                      };
                      video.src = URL.createObjectURL(stream);
                  }, function() {
                      if (document.getElementById('record-screen').checked) {
                          if (location.protocol === 'http:')
                              alert('<https> is mandatory to capture screen.');
                          else
                              alert('Multi-capturing of screen is not allowed. Capturing process is denied. Are you enabled flag: "Enable screen capture support in getUserMedia"?');
                      } else
                          alert('Webcam access is denied.');
                  });

                  window.isAudio = false;

                  if (isRecordVideo) {
                      recordVideo.disabled = true;
                      stopRecordingVideo.disabled = false;
                      pauseResumeVideo.disabled = false;
                  } else {
                      recordGIF.disabled = true;
                      stopRecordingGIF.disabled = false;
                      pauseResumeGif.disabled = false;
                  }
              }

              stopRecordingAudio.onclick = function() {
                  this.disabled = true;
                  recordAudio.disabled = false;
                  audio.src = '';

                  if (recorder)
                      recorder.stopRecording(function(url) {
                          audio.src = url;
                          audio.muted = false;
                          audio.play();

                          document.getElementById('audio-url-preview').innerHTML = '<a href="' + url + '" target="_blank">Recorded Audio URL</a>';
                      });
              };
              
              pauseResumeAudio.onclick = pauseResumeVideo.onclick = pauseResumeGif.onclick =  function() {
                  if(!recorder) return;
                  
                  if(this.innerHTML === 'Pause') {
                      this.innerHTML = 'Resume';
                      recorder.pauseRecording();
                      return;
                  }
                  
                  this.innerHTML = 'Pause';
                  recorder.resumeRecording();
              };

              stopRecordingVideo.onclick = function() {
                  this.disabled = true;
                  recordVideo.disabled = false;

                  if (recorder)
                      recorder.stopRecording(function(url) {
                          video.src = url;
                          video.play();

                          document.getElementById('video-url-preview').innerHTML = '<a href="' + url + '" target="_blank">Recorded Video URL</a>';
                      });
              };

              stopRecordingGIF.onclick = function() {
                  this.disabled = true;
                  recordGIF.disabled = false;

                  if (recorder)
                      recorder.stopRecording(function(url) {
                          document.getElementById('video-url-preview').innerHTML = '<a href="' + url + '" target="_blank">Recorded Gif URL</a>';
                      });
              };
              </script>

              <script>
              document.getElementById('fit-to-screen').onclick = function() {
                  this.disabled = true;

                  video.width = canvasWidth_input.value = innerWidth;
                  video.height = canvasHeight_input.value = innerHeight;
              };
              </script>

          </article>


          <!-- commits.js is useless for you! -->
          <script src="//cdn.webrtc-experiment.com/commits.js" async>
          </script>
      <!-- APP HEADER -->

      <ion-header-bar align-title="left" class="bar-dark bar-header mainHeader" ng-hide="obj.hideMainHeader">
        <div class="title" ng-click="goHome()"></div>
        <div class="buttons">
          <i ng-click="recordVideo()" class="icon ion-videocamera"></i>
          <form ng-hide="true" action="upload.htm" method="post" enctype="multipart/form-data">
            <input ng-hide="true" id="videoCapture" placeholder="Record a Video" ng-model="movie" type="file" accept="video/*;capture=camcorder"/>
            <input class="button button-block" type="submit" value="Upload">
          </form>
          <button class="button button-icon icon ion-navicon"></button>
        </div>
      </ion-header-bar>

      <!-- SEARCH SUB-HEADER -->
      <ion-header-bar class="bar-dark bar-subheader item-input-inset" ng-hide="obj.hideMainHeader">
        <label class="item-input-wrapper search-artist">
          <i class="icon ion-ios-search placeholder-icon"></i>
          <form ng-submit="artistsSearch()">
            <input class="search" type="search" placeholder="Search" ng-model="query">
          </form>
        </label>
      </ion-header-bar>

      <!-- TEMPLATES -->

      <ion-nav-view></ion-nav-view>

    </ion-pane>

  </body>
</html>
